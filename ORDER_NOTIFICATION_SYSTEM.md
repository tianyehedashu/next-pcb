# 📧 订单修改通知系统

## 🎯 功能概述

当用户修改订单时，系统会自动检测状态变化并发送邮件通知给所有管理员，确保管理员能及时了解订单变更情况。

## 🔄 状态转换规则

### 用户修改订单时的状态变化

| 原状态 | 修改后状态 | 说明 | 是否发送通知 |
|--------|------------|------|-------------|
| `reviewed` | `pending` | 已审核订单被修改，需要重新审核 | ✅ 是 |
| `quoted` | `pending` | 已报价订单被修改，需要重新审核 | ✅ 是 |
| `created` | `created` | 新创建订单修改，状态不变 | ❌ 否 |
| `pending` | `pending` | 待审核订单修改，状态不变 | ❌ 否 |
| `draft` | `draft` | 草稿订单修改，状态不变 | ❌ 否 |

### 管理员修改订单

- 管理员修改订单时**不会**触发通知
- 管理员可以自由设置订单状态
- 状态变更会记录在历史表中

## 📨 通知内容

### 邮件主题
```
🔄 订单修改通知 - [订单ID前8位]...
```

### 邮件内容包含
1. **订单基本信息**
   - 订单ID
   - 用户邮箱
   - 修改时间

2. **状态变更信息**
   - 原状态 → 新状态
   - 中文状态显示
   - 特殊提醒（如需要重新审核）

3. **操作建议**
   - 查看订单详情
   - 重新审核提醒
   - 联系用户建议

4. **快捷操作**
   - 直接链接到管理后台订单详情页

## 🔧 技术实现

### API 修改点

**文件**: `app/api/quote/[id]/route.ts`

#### 1. 增强状态转换逻辑
```typescript
function calculateNewStatus(
  currentStatus: string,
  requestedStatus: string | undefined,
  isAdmin: boolean
): string {
  if (!isAdmin) {
    // 用户编辑已报价的订单，状态改为待审核
    if (currentStatus === QuoteStatus.QUOTED) {
      return QuoteStatus.PENDING;
    }
    // 用户编辑已审核的订单，状态也改为待审核（需要重新审核）
    if (currentStatus === QuoteStatus.REVIEWED) {
      return QuoteStatus.PENDING;
    }
  }
  return currentStatus;
}
```

#### 2. 添加通知触发逻辑
```typescript
// 如果是用户修改订单且状态发生变化，发送通知给管理员
if (!isAdmin && newStatus !== existingQuote.status) {
  await notifyAdminsOfOrderChange(
    updatedQuote,
    existingQuote.status,
    newStatus,
    user,
    supabase
  );
}
```

#### 3. 通知函数实现
- 状态中文映射
- 邮件模板生成
- 调用现有的 `notify-customer-service` API
- 错误处理（不阻断主流程）

### 依赖的现有功能

1. **邮件发送API**: `/api/notify-customer-service`
   - 自动获取所有管理员邮箱
   - 使用配置的SMTP服务发送邮件

2. **状态历史记录**: `order_status_history` 表
   - 记录所有状态变更
   - 包含操作人员和变更原因

## 🧪 测试方法

### 测试页面
访问 `/test-notification` 页面进行功能测试

### 测试场景

1. **订单修改测试**
   - 修改一个 `reviewed` 状态的订单
   - 验证状态是否变为 `pending`
   - 检查管理员是否收到邮件

2. **直接通知测试**
   - 直接调用通知API
   - 验证邮件发送功能

### 预期结果

1. ✅ 订单状态正确转换
2. ✅ 管理员收到格式化邮件
3. ✅ 状态变更记录在历史表中
4. ✅ 错误不影响订单修改主流程

## 🎨 邮件样式

- 响应式设计，适配各种邮件客户端
- 清晰的状态变更可视化
- 醒目的操作按钮
- 专业的品牌风格

## 🔒 安全考虑

1. **权限验证**: 只有订单所有者或管理员可以修改订单
2. **状态验证**: 严格的状态转换规则
3. **错误隔离**: 通知失败不影响订单修改
4. **审计追踪**: 完整的状态变更历史记录

## 📈 监控建议

1. **邮件发送成功率**: 监控通知邮件发送状态
2. **状态转换频率**: 统计用户修改订单的频率
3. **管理员响应时间**: 跟踪从通知到处理的时间
4. **错误日志**: 监控通知发送失败的情况

## 🚀 未来优化

1. **实时通知**: 集成WebSocket或Server-Sent Events
2. **通知偏好**: 允许管理员设置通知偏好
3. **批量通知**: 合并短时间内的多个变更通知
4. **移动推送**: 集成移动端推送通知
5. **通知模板**: 支持自定义邮件模板

## 🔍 故障排除

### 常见问题

1. **邮件未收到**
   - 检查SMTP配置
   - 验证管理员邮箱设置
   - 查看垃圾邮件文件夹

2. **状态未变更**
   - 确认用户权限
   - 检查状态转换规则
   - 查看控制台错误日志

3. **通知发送失败**
   - 检查网络连接
   - 验证API端点可用性
   - 查看服务器日志

### 调试步骤

1. 查看浏览器控制台
2. 检查服务器日志
3. 验证数据库状态变更
4. 测试邮件发送功能 