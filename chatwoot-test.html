<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatwoot Pure HTML Test</title>
  <style>
    body { font-family: sans-serif; padding: 2em; line-height: 1.6; }
    h1 { color: #333; }
    #status { padding: 1em; border-radius: 8px; margin-top: 1em; }
    .success { background-color: #e6ffed; border: 1px solid #b7e1c8; color: #006b2e; }
    .error { background-color: #fff0f0; border: 1px solid #ffb3b3; color: #c00; }
    .warning { background-color: #fff8e1; border: 1px solid #ffcc02; color: #b8860b; }
    code { background-color: #f0f0f0; padding: 0.2em 0.4em; border-radius: 4px; }
    .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 1em; border-radius: 8px; margin-top: 1em; max-height: 300px; overflow-y: auto; }
    .log-entry { margin: 0.5em 0; font-family: monospace; font-size: 0.9em; }
    .test-section { margin: 2em 0; padding: 1em; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 0.5em 1em; margin: 0.5em; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
  </style>
</head>
<body>

  <h1>Chatwoot è¯¦ç»†è¯Šæ–­æµ‹è¯•</h1>
  <p>è¿™ä¸ªé¡µé¢å°†è¯¦ç»†æµ‹è¯• Chatwoot çš„åŠ è½½è¿‡ç¨‹ï¼Œå¹¶è¯Šæ–­ 429 é”™è¯¯ã€‚</p>
  
  <div id="status">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>

  <div class="test-section">
    <h3>ğŸ”§ æµ‹è¯•æ§åˆ¶</h3>
    <button class="btn-primary" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
    <button class="btn-danger" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    <button class="btn-primary" onclick="testRateLimit()">æµ‹è¯•é€Ÿç‡é™åˆ¶</button>
  </div>

  <div class="log" id="logContainer">
    <div class="log-entry">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
  </div>

  <script>
    // è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„çœŸå® Website Token
    const WEBSITE_TOKEN = "HKGUzvw8ErEE8zHueiyVSEAn";
    const BASE_URL = "http://www.leodennis.top:3000";

    const statusDiv = document.getElementById('status');
    const logContainer = document.getElementById('logContainer');
    let testStarted = false;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#333';
      logEntry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    function clearLogs() {
      logContainer.innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º...</div>';
    }

    function updateStatus(message, className) {
      statusDiv.innerHTML = message;
      statusDiv.className = className;
    }

    // æµ‹è¯•é€Ÿç‡é™åˆ¶
    async function testRateLimit() {
      log('ğŸš€ å¼€å§‹é€Ÿç‡é™åˆ¶æµ‹è¯•...', 'info');
      updateStatus('ğŸš€ æ­£åœ¨æµ‹è¯•é€Ÿç‡é™åˆ¶...', 'warning');
      
      const promises = [];
      const testUrl = `${BASE_URL}/widget?website_token=${WEBSITE_TOKEN}`;
      
      for (let i = 0; i < 15; i++) {
        promises.push(
          fetch(testUrl, {
            method: 'GET',
            cache: 'no-cache',
          }).then(response => ({
            index: i,
            status: response.status,
            ok: response.ok,
            statusText: response.statusText
          })).catch(error => ({
            index: i,
            error: error.message,
            status: 'network_error'
          }))
        );
      }

      try {
        const results = await Promise.all(promises);
        let successCount = 0;
        let errorCount = 0;
        let rateLimitCount = 0;

        results.forEach(result => {
          if (result.status === 429) {
            rateLimitCount++;
            log(`è¯·æ±‚ ${result.index + 1}: 429 Too Many Requests`, 'error');
          } else if (result.ok || result.status === 200) {
            successCount++;
            log(`è¯·æ±‚ ${result.index + 1}: æˆåŠŸ (${result.status})`, 'success');
          } else if (result.error) {
            errorCount++;
            log(`è¯·æ±‚ ${result.index + 1}: ç½‘ç»œé”™è¯¯ - ${result.error}`, 'error');
          } else {
            errorCount++;
            log(`è¯·æ±‚ ${result.index + 1}: HTTPé”™è¯¯ ${result.status} - ${result.statusText}`, 'error');
          }
        });

        log(`ğŸ“Š æµ‹è¯•ç»“æœ: æˆåŠŸ ${successCount}, 429é”™è¯¯ ${rateLimitCount}, å…¶ä»–é”™è¯¯ ${errorCount}`, 'info');
        
        if (rateLimitCount > 0) {
          updateStatus(`âŒ æ£€æµ‹åˆ° ${rateLimitCount} ä¸ª 429 é”™è¯¯ï¼éœ€è¦é…ç½®æœåŠ¡å™¨ç«¯é€Ÿç‡é™åˆ¶ã€‚`, 'error');
          log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½® ENABLE_RACK_ATTACK_WIDGET_API=false', 'warning');
        } else {
          updateStatus('âœ… é€Ÿç‡é™åˆ¶æµ‹è¯•é€šè¿‡ï¼', 'success');
        }
      } catch (error) {
        log(`âŒ é€Ÿç‡é™åˆ¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('âŒ é€Ÿç‡é™åˆ¶æµ‹è¯•å¤±è´¥', 'error');
      }
    }

    function startTest() {
      if (testStarted) {
        log('âš ï¸ æµ‹è¯•å·²ç»åœ¨è¿›è¡Œä¸­...', 'warning');
        return;
      }

      testStarted = true;
      clearLogs();
      log('ğŸ” å¼€å§‹ Chatwoot åŠ è½½æµ‹è¯•...', 'info');
      updateStatus('ğŸ” æ­£åœ¨æµ‹è¯•...', 'warning');

      // æ£€æŸ¥ Token æ˜¯å¦å·²å¡«å†™
      if (WEBSITE_TOKEN.includes('è¯·åœ¨è¿™é‡Œå¡«å…¥')) {
        log('âŒ é”™è¯¯: Website Token æœªè®¾ç½®ï¼', 'error');
        updateStatus('âŒ é”™è¯¯: è¯·è®¾ç½® Website Tokenï¼', 'error');
        testStarted = false;
        return;
      }

      log(`ğŸ“ æœåŠ¡å™¨: ${BASE_URL}`, 'info');
      log(`ğŸ”‘ Token: ${WEBSITE_TOKEN.substring(0, 8)}...`, 'info');

      // 1. è®¾ç½® Chatwoot å…¨å±€é…ç½®
      window.chatwootSettings = {
        hideMessageBubble: false,
        position: 'right',
        locale: 'en',
        type: 'standard',
        showPopoutButton: false,
        showUnreadMessagesDialog: false, // å‡å°‘ API è°ƒç”¨
      };
      log('âš™ï¸ Chatwoot è®¾ç½®å·²é…ç½®', 'info');

      // 2. åˆ›å»ºå¹¶åŠ è½½è„šæœ¬
      const script = document.createElement('script');
      script.async = true;
      script.defer = true;
      const cleanBaseUrl = BASE_URL.replace(/\/$/, '');
      script.src = `${cleanBaseUrl}/packs/js/sdk.js`;

      log(`ğŸ“¡ æ­£åœ¨ä» ${script.src} åŠ è½½è„šæœ¬...`, 'info');

      // 3. ç›‘å¬åŠ è½½æˆåŠŸäº‹ä»¶
      script.onload = function() {
        log('âœ… Chatwoot è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
        updateStatus('âœ… è„šæœ¬åŠ è½½æˆåŠŸï¼æ­£åœ¨åˆå§‹åŒ–...', 'success');
        
        try {
          // 4. åˆå§‹åŒ– SDK
          window.chatwootSDK.run({
            websiteToken: WEBSITE_TOKEN,
            baseUrl: cleanBaseUrl,
          });
          log('ğŸš€ SDK åˆå§‹åŒ–è°ƒç”¨å®Œæˆ', 'info');
        } catch (error) {
          log(`âŒ SDK åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          updateStatus('âŒ SDK åˆå§‹åŒ–å¤±è´¥', 'error');
          testStarted = false;
        }
      };

      // 5. ç›‘å¬åŠ è½½å¤±è´¥äº‹ä»¶
      script.onerror = function(error) {
        log('âŒ Chatwoot è„šæœ¬åŠ è½½å¤±è´¥', 'error');
        updateStatus('âŒ è„šæœ¬åŠ è½½å¤±è´¥', 'error');
        testStarted = false;
      };

      // 6. ç›‘å¬ Chatwoot ready äº‹ä»¶
      window.addEventListener('chatwoot:ready', function () {
        log('ğŸ‰ Chatwoot SDK åˆå§‹åŒ–å®Œæˆï¼', 'success');
        updateStatus('ğŸ‰ æµ‹è¯•æˆåŠŸï¼Chatwoot å·²å‡†å¤‡å°±ç»ªã€‚', 'success');
        testStarted = false;
      });

      // 7. ç›‘å¬ Chatwoot é”™è¯¯äº‹ä»¶
      window.addEventListener('chatwoot:error', function (event) {
        log(`âŒ Chatwoot é”™è¯¯: ${JSON.stringify(event.detail)}`, 'error');
        updateStatus('âŒ Chatwoot è¿è¡Œæ—¶é”™è¯¯', 'error');
      });

      // 8. å°†è„šæœ¬æ·»åŠ åˆ°é¡µé¢
      document.head.appendChild(script);

      // 9. è®¾ç½®è¶…æ—¶æ£€æµ‹
      setTimeout(() => {
        if (testStarted) {
          log('â° æµ‹è¯•è¶…æ—¶ (30ç§’)ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜æˆ–é€Ÿç‡é™åˆ¶', 'warning');
          updateStatus('â° æµ‹è¯•è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€', 'warning');
          testStarted = false;
        }
      }, 30000);
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
    window.addEventListener('load', function() {
      log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è¯Šæ–­', 'info');
    });

  </script>

  <div class="test-section">
    <h3>ğŸ”§ æœåŠ¡å™¨é…ç½®å»ºè®®</h3>
    <p><strong>å¦‚æœå‡ºç° 429 é”™è¯¯ï¼Œè¯·åœ¨æ‚¨çš„ Chatwoot æœåŠ¡å™¨ä¸Šè®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š</strong></p>
    <code>ENABLE_RACK_ATTACK_WIDGET_API=false</code>
    <p>ç„¶åé‡å¯ Chatwoot æœåŠ¡ã€‚</p>
    
    <p><strong>æˆ–è€…å¢åŠ é€Ÿç‡é™åˆ¶ï¼š</strong></p>
    <code>RACK_ATTACK_LIMIT=300</code>
  </div>

</body>
</html> 