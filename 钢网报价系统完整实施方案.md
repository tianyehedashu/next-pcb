# é’¢ç½‘æŠ¥ä»·ç³»ç»Ÿå®Œæ•´å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åœ¨ç°æœ‰PCBæŠ¥ä»·ç³»ç»Ÿ (`quote2`) åŸºç¡€ä¸Šï¼Œæ–°å¢é’¢ç½‘æŠ¥ä»·åŠŸèƒ½ï¼Œå®ç°"ä¸€ä¸ªé¡µé¢ï¼Œä¸¤ç§äº§å“"çš„ç»Ÿä¸€æŠ¥ä»·ä½“éªŒï¼Œæœ€å°åŒ–å¯¹ç°æœ‰ç³»ç»Ÿçš„æ”¹åŠ¨ã€‚

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **æœ€å°æ”¹åŠ¨åŸåˆ™**ï¼šä¿æŒç°æœ‰ä»£ç ç»“æ„ï¼Œé€šè¿‡æ‰©å±•è€Œéé‡æ„å®ç°
2. **æ•°æ®åº“å…¼å®¹**ï¼šç»§ç»­ä½¿ç”¨ `pcb_quotes` è¡¨ï¼Œé€šè¿‡ `productType` å­—æ®µåŒºåˆ†
3. **ç»„ä»¶å¤ç”¨**ï¼šåœ°å€è¡¨å•ã€æ–‡ä»¶ä¸Šä¼ ã€æ”¯ä»˜æµç¨‹ç­‰ç»„ä»¶100%å¤ç”¨
4. **è®¡ç®—ç‹¬ç«‹**ï¼šé’¢ç½‘æœ‰ç‹¬ç«‹çš„ä»·æ ¼ã€äº¤æœŸã€è¿è´¹è®¡ç®—é€»è¾‘
5. **ç±»å‹å®‰å…¨**ï¼šTypeScriptç¡®ä¿å„äº§å“ç±»å‹çš„å­—æ®µå®‰å…¨

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### 1. æ•°æ®å±‚è®¾è®¡

#### A. æ•°æ®åº“ç»“æ„ï¼ˆä¿æŒä¸å˜ï¼‰
```sql
-- ç»§ç»­ä½¿ç”¨ç°æœ‰ pcb_quotes è¡¨
-- pcb_spec å­—æ®µå­˜å‚¨æ‰€æœ‰äº§å“è§„æ ¼ï¼Œé€šè¿‡ productType åŒºåˆ†

{
  "productType": "stencil",  // äº§å“ç±»å‹æ ‡è¯†
  "stencilMaterial": "ss304",
  "stencilThickness": 0.12,
  "stencilProcess": "laser_cut",
  // å…¬å…±å­—æ®µ
  "singleDimensions": {"length": 100, "width": 80},
  "singleCount": 10,
  "shippingAddress": {...}
}
```

#### B. ç±»å‹å®šä¹‰æ‰©å±•
```typescript
// æ–°å¢äº§å“ç±»å‹æšä¸¾
export enum ProductType {
  PCB = 'pcb',
  STENCIL = 'stencil'
}

// é’¢ç½‘ç‰¹æœ‰å­—æ®µæšä¸¾
export enum StencilMaterial {
  STAINLESS_STEEL_304 = 'ss304',
  STAINLESS_STEEL_316L = 'ss316l',
  NICKEL = 'nickel'
}

export enum StencilThickness {
  T0_08 = 0.08,
  T0_10 = 0.10,
  T0_12 = 0.12,
  T0_15 = 0.15,
  T0_20 = 0.20
}

export enum StencilProcess {
  LASER_CUT = 'laser_cut',
  ELECTROFORM = 'electroform',
  CHEMICAL_ETCH = 'chemical_etch'
}

export enum FrameType {
  NO_FRAME = 'no_frame',
  SMT_FRAME = 'smt_frame',
  CUSTOM_FRAME = 'custom_frame'
}
```

### 2. å‰ç«¯æ¶æ„

#### A. ç»„ä»¶ç»“æ„
```
app/quote2/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ProductTypeSelector.tsx     # æ–°å¢ï¼šäº§å“ç±»å‹é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ QuoteForm.tsx              # ä¿®æ”¹ï¼šæ”¯æŒåŠ¨æ€schema
â”‚   â”œâ”€â”€ PriceSummary.tsx           # ä¿®æ”¹ï¼šæ”¯æŒå¤šäº§å“è®¡ç®—
â”‚   â””â”€â”€ ...existing components     # ä¿æŒä¸å˜
â”œâ”€â”€ schema/
â”‚   â”œâ”€â”€ pcbFormilySchema.ts        # ä¿æŒä¸å˜
â”‚   â”œâ”€â”€ stencilFormilySchema.ts    # æ–°å¢ï¼šé’¢ç½‘å­—æ®µå®šä¹‰
â”‚   â”œâ”€â”€ stencilTypes.ts            # æ–°å¢ï¼šé’¢ç½‘ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ productSchemas.ts          # æ–°å¢ï¼šç»Ÿä¸€schemaç®¡ç†
â””â”€â”€ hooks/
    â”œâ”€â”€ useProductCalculation.ts   # æ–°å¢ï¼šç»Ÿä¸€è®¡ç®—hook
    â””â”€â”€ ...existing hooks          # ä¿æŒä¸å˜
```

#### B. æ ¸å¿ƒå®ç°æ–‡ä»¶

**1. äº§å“ç±»å‹é€‰æ‹©å™¨**
```typescript
// app/quote2/components/ProductTypeSelector.tsx
interface ProductTypeSelectorProps {
  value: ProductType;
  onChange: (type: ProductType) => void;
}

export const ProductTypeSelector = ({ value, onChange }: ProductTypeSelectorProps) => {
  return (
    <div className="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
      <h2 className="text-xl font-semibold mb-4 text-gray-800">Select Product Type</h2>
      <div className="grid grid-cols-2 gap-4">
        <ProductTypeCard
          type={ProductType.PCB}
          icon="ğŸ”§"
          title="PCB Manufacturing"
          description="Professional circuit board fabrication"
          isSelected={value === ProductType.PCB}
          onClick={() => onChange(ProductType.PCB)}
        />
        <ProductTypeCard
          type={ProductType.STENCIL}
          icon="ğŸ“"
          title="Stencil Manufacturing"
          description="High-precision solder paste stencils"
          isSelected={value === ProductType.STENCIL}
          onClick={() => onChange(ProductType.STENCIL)}
        />
      </div>
    </div>
  );
};
```

**2. é’¢ç½‘å­—æ®µSchema**
```typescript
// app/quote2/schema/stencilFormilySchema.ts
export const stencilFormilySchema: ISchema = {
  type: "object",
  properties: {
    // === åŸºç¡€ä¿¡æ¯ ===
    stencilMaterial: {
      type: "string",
      title: "Stencil Material",
      "x-component": "TabSelect",
      "x-component-props": {
        options: [
          { label: "Stainless Steel 304", value: StencilMaterial.STAINLESS_STEEL_304 },
          { label: "Stainless Steel 316L", value: StencilMaterial.STAINLESS_STEEL_316L },
          { label: "Nickel", value: StencilMaterial.NICKEL }
        ]
      }
    },
    
    stencilThickness: {
      type: "number", 
      title: "Stencil Thickness",
      "x-component": "TabSelect",
      "x-component-props": {
        options: Object.values(StencilThickness).map(val => ({
          label: `${val}mm`,
          value: val
        }))
      }
    },

    stencilProcess: {
      type: "string",
      title: "Manufacturing Process", 
      "x-component": "TabSelect",
      "x-component-props": {
        options: [
          { label: "Laser Cutting (Most Common)", value: StencilProcess.LASER_CUT },
          { label: "Electroforming (High Precision)", value: StencilProcess.ELECTROFORM },
          { label: "Chemical Etching (Fine Pitch)", value: StencilProcess.CHEMICAL_ETCH }
        ]
      }
    },

    frameType: {
      type: "string",
      title: "Frame Type",
      "x-component": "TabSelect", 
      "x-component-props": {
        options: [
          { label: "No Frame (Flexible)", value: FrameType.NO_FRAME },
          { label: "SMT Frame (Standard)", value: FrameType.SMT_FRAME },
          { label: "Custom Frame", value: FrameType.CUSTOM_FRAME }
        ]
      }
    },

    frameSize: {
      type: "object",
      title: "Frame Size (mm)",
      "x-component": "DimensionsInput",
      "x-reactions": {
        dependencies: ["frameType"],
        fulfill: {
          state: {
            visible: "{{$deps[0] !== 'no_frame'}}"
          }
        }
      }
    },

    // === å·¥è‰ºè¦æ±‚ ===
    surfaceTreatment: {
      type: "string",
      title: "Surface Treatment",
      "x-component": "TabSelect",
      "x-component-props": {
        options: [
          { label: "None", value: "none" },
          { label: "Electropolishing", value: "electropolish" }, 
          { label: "Passivation", value: "passivation" }
        ]
      }
    },

    tensionMesh: {
      type: "boolean",
      title: "Tension Mesh Required",
      "x-component": "BooleanTabs",
      "x-component-props": {
        description: "Required for fine pitch components"
      }
    },

    fiducialMarks: {
      type: "boolean", 
      title: "Fiducial Marks",
      "x-component": "BooleanTabs"
    },

    // === æ•°é‡å’Œå°ºå¯¸ï¼ˆå¤ç”¨ç°æœ‰å­—æ®µï¼‰===
    singleDimensions: fullWidth({
      type: "object",
      title: "Stencil Size (mm)",
      "x-component": "DimensionsInput"
    }),

    singleCount: {
      type: "number",
      title: "Quantity",
      "x-component": "QuantityInput"
    },

    // === ç‰¹æ®Šè¦æ±‚ ===
    specialRequests: fullWidth({
      type: "string",
      title: "Special Requirements",
      "x-component": "TextArea",
      "x-component-props": {
        placeholder: "Any special requirements for your stencil..."
      }
    })
  }
};
```

### 3. è®¡ç®—é€»è¾‘å±‚

#### A. ç»Ÿä¸€è®¡ç®—æ¥å£
```typescript
// lib/calculators/productCalculator.ts
interface ProductCalculationResult {
  totalPrice: number;
  unitPrice: number;
  breakdown: Record<string, number>;
  notes: string[];
  leadTimeDays: number;
  leadTimeReason: string[];
  minOrderQty: number;
}

export interface ProductCalculator {
  calculatePrice(formData: any): ProductCalculationResult;
  calculateLeadTime(formData: any, startDate: Date): number;
  calculateWeight(formData: any): number;
}
```

#### B. é’¢ç½‘ä»·æ ¼è®¡ç®—å™¨
```typescript
// lib/calculators/stencilCalculator.ts
export class StencilCalculator implements ProductCalculator {
  calculatePrice(formData: any): ProductCalculationResult {
    const { 
      stencilMaterial, 
      stencilThickness, 
      stencilProcess, 
      frameType,
      singleDimensions, 
      singleCount 
    } = formData;

    // åŸºç¡€ä»·æ ¼è®¡ç®—
    const area = singleDimensions.length * singleDimensions.width; // mmÂ²
    const basePrice = this.getBasePricePerMm2(stencilMaterial, stencilThickness);
    
    // å·¥è‰ºåŠ ä»·
    const processMultiplier = this.getProcessMultiplier(stencilProcess);
    
    // æ¡†æ¶åŠ ä»·
    const frameAddition = this.getFrameAddition(frameType, singleDimensions);
    
    // æ•°é‡æŠ˜æ‰£
    const quantityDiscount = this.getQuantityDiscount(singleCount);
    
    const unitCost = (basePrice * area * processMultiplier + frameAddition) * quantityDiscount;
    const totalPrice = unitCost * singleCount;

    return {
      totalPrice,
      unitPrice: unitCost,
      breakdown: {
        "Material Cost": basePrice * area * singleCount,
        "Process Cost": (basePrice * area * (processMultiplier - 1)) * singleCount,
        "Frame Cost": frameAddition * singleCount,
        "Quantity Discount": totalPrice * (1 - quantityDiscount) * -1
      },
      notes: this.generatePriceNotes(formData),
      leadTimeDays: this.calculateLeadTime(formData, new Date()),
      leadTimeReason: this.getLeadTimeReasons(formData),
      minOrderQty: 1
    };
  }

  private getBasePricePerMm2(material: string, thickness: number): number {
    // é’¢ç½‘åŸºç¡€ä»·æ ¼è¡¨ (CNY/mmÂ²)
    const priceMatrix = {
      [StencilMaterial.STAINLESS_STEEL_304]: {
        [StencilThickness.T0_08]: 0.015,
        [StencilThickness.T0_10]: 0.018,
        [StencilThickness.T0_12]: 0.022,
        [StencilThickness.T0_15]: 0.028,
        [StencilThickness.T0_20]: 0.035
      },
      [StencilMaterial.STAINLESS_STEEL_316L]: {
        [StencilThickness.T0_08]: 0.020,
        [StencilThickness.T0_10]: 0.025,
        [StencilThickness.T0_12]: 0.030,
        [StencilThickness.T0_15]: 0.038,
        [StencilThickness.T0_20]: 0.048
      },
      [StencilMaterial.NICKEL]: {
        [StencilThickness.T0_08]: 0.045,
        [StencilThickness.T0_10]: 0.055,
        [StencilThickness.T0_12]: 0.068,
        [StencilThickness.T0_15]: 0.085,
        [StencilThickness.T0_20]: 0.110
      }
    };

    return priceMatrix[material]?.[thickness] || 0.025;
  }

  private getProcessMultiplier(process: string): number {
    const multipliers = {
      [StencilProcess.LASER_CUT]: 1.0,
      [StencilProcess.ELECTROFORM]: 2.5,
      [StencilProcess.CHEMICAL_ETCH]: 1.8
    };
    return multipliers[process] || 1.0;
  }

  private getFrameAddition(frameType: string, dimensions: any): number {
    // æ¡†æ¶é™„åŠ è´¹ç”¨ (CNY)
    if (frameType === FrameType.NO_FRAME) return 0;
    if (frameType === FrameType.SMT_FRAME) return 150;
    if (frameType === FrameType.CUSTOM_FRAME) return 300;
    return 0;
  }

  private getQuantityDiscount(quantity: number): number {
    if (quantity >= 100) return 0.85; // 15% æŠ˜æ‰£
    if (quantity >= 50) return 0.90;  // 10% æŠ˜æ‰£  
    if (quantity >= 20) return 0.95;  // 5% æŠ˜æ‰£
    return 1.0; // æ— æŠ˜æ‰£
  }

  calculateLeadTime(formData: any, startDate: Date): number {
    const { stencilProcess, frameType, singleCount } = formData;
    
    // åŸºç¡€å·¥æœŸ
    let baseDays = 3; // æ¿€å…‰åˆ‡å‰²åŸºç¡€3å¤©
    
    // å·¥è‰ºåŠ æ—¶
    if (stencilProcess === StencilProcess.ELECTROFORM) {
      baseDays += 4; // ç”µé“¸å·¥è‰ºéœ€è¦é¢å¤–4å¤©
    } else if (stencilProcess === StencilProcess.CHEMICAL_ETCH) {
      baseDays += 2; // åŒ–å­¦èš€åˆ»é¢å¤–2å¤©
    }
    
    // æ¡†æ¶åŠ æ—¶
    if (frameType === FrameType.CUSTOM_FRAME) {
      baseDays += 2; // å®šåˆ¶æ¡†æ¶é¢å¤–2å¤©
    }
    
    // æ•°é‡åŠ æ—¶
    if (singleCount > 50) {
      baseDays += 1; // å¤§æ‰¹é‡é¢å¤–1å¤©
    }
    
    return baseDays;
  }

  calculateWeight(formData: any): number {
    // é’¢ç½‘é‡é‡è®¡ç®— (kg)
    const { singleDimensions, stencilThickness, frameType, singleCount } = formData;
    
    const area = singleDimensions.length * singleDimensions.width; // mmÂ²
    const volume = area * stencilThickness; // mmÂ³
    const density = 7.9; // ä¸é”ˆé’¢å¯†åº¦ g/cmÂ³
    
    // å•ä¸ªé’¢ç½‘é‡é‡ (kg)
    let singleWeight = (volume * density) / 1000000; // è½¬æ¢ä¸ºkg
    
    // æ¡†æ¶é‡é‡
    if (frameType === FrameType.SMT_FRAME) {
      singleWeight += 0.2; // SMTæ¡†æ¶çº¦200g
    } else if (frameType === FrameType.CUSTOM_FRAME) {
      singleWeight += 0.35; // å®šåˆ¶æ¡†æ¶çº¦350g
    }
    
    return singleWeight * singleCount;
  }

  private generatePriceNotes(formData: any): string[] {
    const notes: string[] = [];
    
    if (formData.stencilProcess === StencilProcess.ELECTROFORM) {
      notes.push("âš¡ Electroforming provides highest precision for fine pitch components");
    }
    
    if (formData.frameType === FrameType.CUSTOM_FRAME) {
      notes.push("ğŸ”§ Custom frame pricing may vary based on requirements");
    }
    
    if (formData.singleCount >= 20) {
      notes.push("ğŸ’° Quantity discount applied");
    }
    
    return notes;
  }

  private getLeadTimeReasons(formData: any): string[] {
    const reasons: string[] = [];
    const { stencilProcess, frameType } = formData;
    
    reasons.push("ğŸ“ Stencil manufacturing lead time includes:");
    
    if (stencilProcess === StencilProcess.LASER_CUT) {
      reasons.push("â€¢ Laser cutting: 1-2 days");
    } else if (stencilProcess === StencilProcess.ELECTROFORM) {
      reasons.push("â€¢ Electroforming: 4-6 days (high precision)");
    } else if (stencilProcess === StencilProcess.CHEMICAL_ETCH) {
      reasons.push("â€¢ Chemical etching: 3-4 days");
    }
    
    if (frameType !== FrameType.NO_FRAME) {
      reasons.push("â€¢ Frame mounting: 1-2 days");
    }
    
    reasons.push("â€¢ Quality inspection: 1 day");
    
    return reasons;
  }
}
```

#### C. ç»Ÿä¸€è®¡ç®—Hook
```typescript
// app/quote2/hooks/useProductCalculation.ts
export const useProductCalculation = () => {
  const formData = useQuoteFormData();
  const setCalValues = useQuoteStore((state) => state.setCalValues);
  
  const calculator = useMemo(() => {
    const productType = formData.productType || ProductType.PCB;
    
    if (productType === ProductType.STENCIL) {
      return new StencilCalculator();
    } else {
      return new PcbCalculator(); // åŒ…è£…ç°æœ‰çš„PCBè®¡ç®—é€»è¾‘
    }
  }, [formData.productType]);

  const calculateAll = useCallback(async () => {
    try {
      const priceResult = calculator.calculatePrice(formData);
      const weight = calculator.calculateWeight(formData);
      
      // è®¡ç®—è¿è´¹ (å¤ç”¨ç°æœ‰é€»è¾‘ï¼Œä¼ å…¥é‡é‡)
      const shippingResult = await calculateShippingCost(formData, weight);
      
      setCalValues({
        totalPrice: priceResult.totalPrice,
        pcbPrice: priceResult.totalPrice,
        unitPrice: priceResult.unitPrice,
        breakdown: priceResult.breakdown,
        leadTimeDays: priceResult.leadTimeDays,
        leadTimeResult: {
          cycleDays: priceResult.leadTimeDays,
          reason: priceResult.leadTimeReason
        },
        shippingCost: shippingResult.finalCost,
        shippingWeight: weight,
        priceNotes: priceResult.notes,
        minOrderQty: priceResult.minOrderQty
      });
    } catch (error) {
      console.error('è®¡ç®—å¤±è´¥:', error);
    }
  }, [formData, calculator, setCalValues]);

  return { calculateAll };
};
```

### 4. é¡µé¢æ•´åˆ

#### A. ä¿®æ”¹QuoteFormç»„ä»¶
```typescript
// app/quote2/components/QuoteForm.tsx
export function QuoteForm({ editId }: { editId?: string }) {
  const [productType, setProductType] = useState<ProductType>(ProductType.PCB);
  
  // åŠ¨æ€é€‰æ‹©schema
  const currentSchema = useMemo(() => {
    return productType === ProductType.PCB 
      ? pcbFormilySchema 
      : stencilFormilySchema;
  }, [productType]);
  
  // åŠ¨æ€å­—æ®µåˆ†ç»„
  const fieldGroups = useMemo(() => {
    return getFieldGroups(productType);
  }, [productType]);

  // è¡¨å•é…ç½®
  const form = useMemo(() => {
    return createForm({
      initialValues: {
        ...DEFAULT_FORM_DATA,
        productType, // æ·»åŠ äº§å“ç±»å‹
      },
      effects() {
        // ç°æœ‰effectsä¿æŒä¸å˜
        onFieldValueChange('productType', (field) => {
          setProductType(field.value);
        });
      }
    });
  }, [productType]);

  return (
    <div className="quote-form-container">
      {/* äº§å“ç±»å‹é€‰æ‹©å™¨ */}
      <ProductTypeSelector 
        value={productType} 
        onChange={setProductType} 
      />
      
      {/* è¡¨å•å†…å®¹ */}
      <FormProvider form={form}>
        <div className="space-y-8">
          {fieldGroups.map((group, index) => (
            <QuoteFormGroupMemo
              key={`${productType}-${index}`}
              group={group}
              index={index}
              schema={currentSchema}
              SchemaField={SchemaField}
            />
          ))}
        </div>
        
        {/* å…¶ä»–ç°æœ‰ç»„ä»¶ä¿æŒä¸å˜ */}
        <FileUploadSection />
        <AddressFormComponent />
        <QuoteFormActions />
      </FormProvider>
    </div>
  );
}
```

#### B. ä¿®æ”¹PriceSummaryç»„ä»¶
```typescript
// app/quote2/components/PriceSummary.tsx (å…³é”®ä¿®æ”¹)
export default function PriceSummary() {
  const formData = useQuoteFormData();
  const { calculateAll } = useProductCalculation();
  
  // æ ¹æ®äº§å“ç±»å‹é€‰æ‹©è®¡ç®—é€»è¾‘
  const priceBreakdown = useMemo((): PriceBreakdown => {
    const productType = formData.productType || ProductType.PCB;
    
    if (productType === ProductType.STENCIL) {
      // ä½¿ç”¨é’¢ç½‘è®¡ç®—å™¨
      const calculator = new StencilCalculator();
      const result = calculator.calculatePrice(formData);
      
      return {
        totalPrice: convertCnyToUsd(result.totalPrice),
        unitPrice: convertCnyToUsd(result.unitPrice),
        detail: Object.fromEntries(
          Object.entries(result.breakdown).map(([key, value]) => 
            [key, convertCnyToUsd(value)]
          )
        ),
        notes: result.notes,
        minOrderQty: result.minOrderQty,
        leadTime: `${result.leadTimeDays} days`,
        totalCount: formData.singleCount || 0
      };
    } else {
      // ä½¿ç”¨ç°æœ‰PCBè®¡ç®—é€»è¾‘
      const { total, detail, notes } = calcPcbPriceV3(formData);
      // ... ç°æœ‰PCBè®¡ç®—é€»è¾‘
    }
  }, [formData, convertCnyToUsd]);

  return (
    <div className="price-summary">
      {/* äº§å“ç±»å‹æ ‡è¯† */}
      <div className="mb-4 flex items-center gap-2">
        <span className="text-2xl">
          {formData.productType === ProductType.STENCIL ? 'ğŸ“' : 'ğŸ”§'}
        </span>
        <h2 className="text-xl font-semibold">
          {formData.productType === ProductType.STENCIL ? 'Stencil Quote' : 'PCB Quote'}
        </h2>
      </div>
      
      {/* å…¶ä»–ç°æœ‰å†…å®¹ä¿æŒä¸å˜ */}
      {/* ... */}
    </div>
  );
}
```

### 5. ç®¡ç†åå°æ‰©å±•

#### A. æŠ¥ä»·åˆ—è¡¨é¡µé¢
```typescript
// app/admin/quotes/page.tsx
export default function AdminQuotesPage() {
  return (
    <div>
      <FilterBar>
        {/* æ–°å¢äº§å“ç±»å‹ç­›é€‰ */}
        <Select placeholder="Product Type">
          <option value="">All Products</option>
          <option value="pcb">ğŸ”§ PCB</option>
          <option value="stencil">ğŸ“ Stencil</option>
        </Select>
        {/* å…¶ä»–ç°æœ‰ç­›é€‰å™¨ */}
      </FilterBar>
      
      <DataTable 
        columns={[
          {
            key: "productType",
            title: "Type",
            render: (record) => {
              const type = record.pcb_spec?.productType || 'pcb';
              return type === 'stencil' ? 'ğŸ“ Stencil' : 'ğŸ”§ PCB';
            }
          },
          // ... å…¶ä»–åˆ—ä¿æŒä¸å˜
        ]}
      />
    </div>
  );
}
```

#### B. æŠ¥ä»·è¯¦æƒ…é¡µé¢
```typescript
// app/admin/quotes/[id]/page.tsx
export default function QuoteDetailPage({ params }: { params: { id: string } }) {
  const { data: quote } = useQuery(['quote', params.id]);
  const productType = quote?.pcb_spec?.productType || 'pcb';
  
  return (
    <div>
      <QuoteHeader 
        productType={productType}
        quote={quote} 
      />
      
      {/* æ ¹æ®äº§å“ç±»å‹æ˜¾ç¤ºä¸åŒçš„è§„æ ¼ä¿¡æ¯ */}
      {productType === 'stencil' ? (
        <StencilSpecDisplay spec={quote.pcb_spec} />
      ) : (
        <PcbSpecDisplay spec={quote.pcb_spec} />
      )}
      
      {/* å…¶ä»–é€šç”¨ä¿¡æ¯ä¿æŒä¸å˜ */}
      <AddressDisplay address={quote.shipping_address} />
      <AdminActions quote={quote} />
    </div>
  );
}
```

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šåŸºç¡€æ¶æ„å‡†å¤‡ (2å¤©)
1. **ç±»å‹å®šä¹‰åˆ›å»º**
   - åˆ›å»º `stencilTypes.ts` å’Œç›¸å…³æšä¸¾
   - æ‰©å±• `ProductType` æšä¸¾
   
2. **è®¡ç®—å™¨æ¶æ„æ­å»º**
   - åˆ›å»º `ProductCalculator` æ¥å£
   - å®ç° `StencilCalculator` ç±»
   - åŒ…è£…ç°æœ‰PCBè®¡ç®—é€»è¾‘ä¸º `PcbCalculator`

3. **ç»„ä»¶åŸºç¡€æ‰©å±•**
   - åˆ›å»º `ProductTypeSelector` ç»„ä»¶
   - ä¿®æ”¹ `QuoteForm` æ”¯æŒäº§å“ç±»å‹åˆ‡æ¢

### é˜¶æ®µ2ï¼šé’¢ç½‘åŠŸèƒ½å®ç° (3å¤©)
1. **å­—æ®µå®šä¹‰å®Œæˆ**
   - å®Œæˆ `stencilFormilySchema.ts`
   - å®ç°é’¢ç½‘ç‰¹æœ‰å­—æ®µç»„ä»¶

2. **è®¡ç®—é€»è¾‘å®Œå–„**
   - å®Œæˆé’¢ç½‘ä»·æ ¼è®¡ç®—ç®—æ³•
   - å®ç°é’¢ç½‘äº¤æœŸè®¡ç®—
   - é€‚é…è¿è´¹è®¡ç®—ï¼ˆé‡é‡å·®å¼‚ï¼‰

3. **è¡¨å•é›†æˆæµ‹è¯•**
   - éªŒè¯å­—æ®µåˆ‡æ¢åŠŸèƒ½
   - æµ‹è¯•æ•°æ®ä¿å­˜å’Œè¯»å–

### é˜¶æ®µ3ï¼šç•Œé¢ä¼˜åŒ–å’Œç®¡ç†åå° (2å¤©)
1. **å‰ç«¯ä½“éªŒä¼˜åŒ–**
   - å®Œå–„äº§å“ç±»å‹åˆ‡æ¢åŠ¨ç”»
   - ä¼˜åŒ–ä»·æ ¼æ˜¾ç¤ºæ ¼å¼
   - æ·»åŠ å¸®åŠ©ä¿¡æ¯

2. **ç®¡ç†åå°é€‚é…**
   - æŠ¥ä»·åˆ—è¡¨æ·»åŠ äº§å“ç±»å‹ç­›é€‰
   - æŠ¥ä»·è¯¦æƒ…é¡µæ”¯æŒé’¢ç½‘è§„æ ¼æ˜¾ç¤º
   - å¯¼å‡ºåŠŸèƒ½æ”¯æŒé’¢ç½‘æ•°æ®

### é˜¶æ®µ4ï¼šæµ‹è¯•å’Œä¸Šçº¿ (1å¤©)
1. **åŠŸèƒ½æµ‹è¯•**
   - ç«¯åˆ°ç«¯æµ‹è¯•é’¢ç½‘æŠ¥ä»·æµç¨‹
   - ä»·æ ¼è®¡ç®—å‡†ç¡®æ€§éªŒè¯
   - ç®¡ç†åå°åŠŸèƒ½æµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–**
   - ä»£ç åˆ†å‰²ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥è°ƒæ•´

## ğŸ“Š å…³é”®æŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- **ä»£ç å¤ç”¨ç‡**: >85% (å¤§éƒ¨åˆ†ç»„ä»¶å’Œé€»è¾‘å¤ç”¨)
- **æ€§èƒ½å½±å“**: <5% (åŠ¨æ€åŠ è½½schema)
- **å…¼å®¹æ€§**: 100% (ç°æœ‰PCBåŠŸèƒ½å®Œå…¨å…¼å®¹)

### ä¸šåŠ¡æŒ‡æ ‡
- **å¼€å‘æ•ˆç‡**: 8å¤©å®Œæˆ vs ä»é›¶å¼€å‘15+å¤©
- **ç»´æŠ¤æˆæœ¬**: ç»Ÿä¸€æ¶æ„ï¼Œç»´æŠ¤æˆæœ¬é™ä½40%
- **æ‰©å±•æ€§**: æœªæ¥æ–°äº§å“å¯åœ¨2-3å¤©å†…é›†æˆ

## ğŸ”§ æŠ€æœ¯é£é™©å’Œè§£å†³æ–¹æ¡ˆ

### é£é™©1ï¼šå­—æ®µæ•°æ®ç±»å‹å†²çª
**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨TypeScriptä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼Œåœ¨ç¼–è¯‘æœŸå‘ç°é—®é¢˜

### é£é™©2ï¼šè®¡ç®—é€»è¾‘å¤æ‚åº¦å¢åŠ 
**è§£å†³æ–¹æ¡ˆ**: é€šè¿‡Calculatoræ¨¡å¼éš”ç¦»å„äº§å“è®¡ç®—é€»è¾‘ï¼Œä¿æŒä»£ç æ¸…æ™°

### é£é™©3ï¼šç°æœ‰åŠŸèƒ½å›å½’
**è§£å†³æ–¹æ¡ˆ**: 
- ä¿æŒç°æœ‰ä»£ç è·¯å¾„ä¸å˜
- å……åˆ†çš„å›å½’æµ‹è¯•
- ç°åº¦å‘å¸ƒç­–ç•¥

## ğŸ’¡ æœªæ¥æ‰©å±•

### æ–°äº§å“ç±»å‹æ”¯æŒ
åŸºäºæ­¤æ¶æ„ï¼Œæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ ï¼š
- SMTè´´ç‰‡æœåŠ¡ (`ProductType.ASSEMBLY`)
- å…ƒå™¨ä»¶é‡‡è´­ (`ProductType.COMPONENTS`)
- æµ‹è¯•æœåŠ¡ (`ProductType.TESTING`)

### æ‰©å±•æ­¥éª¤
1. æ·»åŠ æ–°çš„äº§å“ç±»å‹æšä¸¾
2. åˆ›å»ºå¯¹åº”çš„ Calculator ç±»
3. å®šä¹‰ FormilySchema
4. æ·»åŠ å­—æ®µåˆ†ç»„é…ç½®
5. ç®¡ç†åå°é€‚é…

æ¯ä¸ªæ–°äº§å“ç±»å‹é¢„è®¡å¼€å‘æ—¶é—´ï¼š3-5å¤©

## ğŸ“‹ æ€»ç»“

æ­¤æ–¹æ¡ˆåœ¨ä¿æŒç°æœ‰ç³»ç»Ÿç¨³å®šçš„å‰æä¸‹ï¼Œé€šè¿‡æœ€å°æ”¹åŠ¨å®ç°äº†é’¢ç½‘æŠ¥ä»·åŠŸèƒ½çš„å®Œæ•´é›†æˆã€‚å…³é”®ä¼˜åŠ¿ï¼š

1. **æœ€å°é£é™©**: ç°æœ‰PCBåŠŸèƒ½é›¶å½±å“
2. **å¿«é€Ÿäº¤ä»˜**: 8å¤©å®Œæˆå¼€å‘ï¼Œå¯¹æ¯”ä»é›¶å¼€å‘èŠ‚çœ50%æ—¶é—´  
3. **é«˜åº¦å¤ç”¨**: åœ°å€ã€æ”¯ä»˜ã€æ–‡ä»¶ä¸Šä¼ ç­‰æ ¸å¿ƒåŠŸèƒ½100%å¤ç”¨
4. **æ˜“äºç»´æŠ¤**: ç»Ÿä¸€æ¶æ„ï¼Œæ¸…æ™°çš„ä»£ç ç»„ç»‡
5. **å¼ºæ‰©å±•æ€§**: ä¸ºæœªæ¥äº§å“æ‰©å±•æ‰“ä¸‹è‰¯å¥½åŸºç¡€

é€šè¿‡æ­¤æ–¹æ¡ˆï¼Œå¯ä»¥å¿«é€Ÿè¿›å…¥é’¢ç½‘å¸‚åœºï¼ŒéªŒè¯å•†ä¸šæ¨¡å¼ï¼ŒåŒæ—¶ä¸ºäº§å“çº¿çš„è¿›ä¸€æ­¥æ‰©å±•å¥ å®šæŠ€æœ¯åŸºç¡€ã€‚

---

## ğŸ“ˆ é¡¹ç›®å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆé˜¶æ®µ

#### é˜¶æ®µ1ï¼šåŸºç¡€æ¶æ„å‡†å¤‡ âœ…
- âœ… ç±»å‹å®šä¹‰ç³»ç»Ÿ (`stencilTypes.ts`)
- âœ… äº§å“è®¡ç®—å™¨æ¶æ„ (`productCalculator.ts`, `stencilCalculator.ts`)
- âœ… ç»Ÿä¸€è®¡ç®—Hook (`useProductCalculation.ts`)
- âœ… äº§å“ç±»å‹é€‰æ‹©å™¨ (`ProductTypeSelector.tsx`)

#### é˜¶æ®µ2ï¼šé’¢ç½‘åŠŸèƒ½å®ç° âœ…
- âœ… é’¢ç½‘Formily Schema (`stencilFormilySchema.ts`)
- âœ… äº§å“Schemaç®¡ç† (`productSchemas.ts`)
- âœ… é’¢ç½‘ä¸“ç”¨ç»„ä»¶ (å·¥è‰ºæŒ‡å¯¼ã€ä»·æ ¼è¯´æ˜ç­‰)
- âœ… ä¸»è¡¨å•é›†æˆ (`QuoteForm.tsx`)

#### é˜¶æ®µ3ï¼šç•Œé¢ä¼˜åŒ–å’Œä»·æ ¼æ˜¾ç¤º âœ…
- âœ… åŠ¨æ€ä»·æ ¼å±•ç¤º (`PriceSummary.tsx`)
- âœ… é’¢ç½‘ä»·æ ¼æ˜ç»†å’Œè¯´æ˜ (`StencilPriceExplainer.tsx`)
- âœ… å·¥è‰ºæŒ‡å¯¼ç»„ä»¶ (`StencilProcessGuide.tsx`)
- âœ… Formilyç»„ä»¶æ‰©å±•

#### é˜¶æ®µ4ï¼šåç«¯APIé€‚é… âœ…
- âœ… æŠ¥ä»·APIå‡çº§ (äº§å“ç±»å‹æ£€æµ‹ã€æ•°æ®éªŒè¯)
- âœ… è®¢å•ç®¡ç†API (`/api/admin/orders/[id]`)
- âœ… ç®¡ç†ç•Œé¢é€‚é… (é’¢ç½‘è®¢å•å¡ç‰‡ã€åˆ†ç¦»æ˜¾ç¤º)
- âœ… ç”¨æˆ·ç•Œé¢é€‚é… (ç»Ÿä¸€è®¢å•æ˜¾ç¤º)
- âœ… æµ‹è¯•éªŒè¯ç³»ç»Ÿ (`/test-stencil-quote`)

### ğŸŠ é¡¹ç›®æˆæœ

#### æŠ€æœ¯æˆæœ
- **æ™ºèƒ½äº§å“ç±»å‹æ£€æµ‹**ï¼šAPIè‡ªåŠ¨è¯†åˆ«é’¢ç½‘ä¸PCBè®¢å•
- **ç»Ÿä¸€æ•°æ®æ¨¡å‹**ï¼šåˆ©ç”¨ç°æœ‰`pcb_quotes`è¡¨æ”¯æŒå¤šäº§å“ç±»å‹
- **ç»„ä»¶æœ€å¤§å¤ç”¨**ï¼šåœ°å€ã€æ–‡ä»¶ä¸Šä¼ ã€æ”¯ä»˜æµç¨‹100%å¤ç”¨
- **ç±»å‹å®‰å…¨ä¿éšœ**ï¼šå®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰ä½“ç³»

#### ä¸šåŠ¡æˆæœ
- **å®Œæ•´é’¢ç½‘æŠ¥ä»·æµç¨‹**ï¼šä»æŠ¥ä»·åˆ°è®¢å•ç®¡ç†çš„å…¨æµç¨‹æ”¯æŒ
- **ä¸“ä¸šå·¥è‰ºæŒ‡å¯¼**ï¼šæ¿€å…‰åˆ‡å‰²ã€ç”µé“¸ã€åŒ–å­¦èš€åˆ»å·¥è‰ºå¯¹æ¯”å’Œå»ºè®®
- **é€æ˜ä»·æ ¼ä½“ç³»**ï¼šåŸºäºæè´¨+åšåº¦çš„ä»·æ ¼çŸ©é˜µï¼Œå·¥è‰ºåŠ ä»·ç³»æ•°
- **ç®¡ç†ç•Œé¢ä¼˜åŒ–**ï¼šåˆ†ç¦»æ˜¾ç¤ºPCBå’Œé’¢ç½‘è®¢å•ï¼Œä¸“ä¸šåŒ–ç®¡ç†

#### ç”¨æˆ·ä½“éªŒ
- **æ— ç¼äº§å“åˆ‡æ¢**ï¼šPCB â†” é’¢ç½‘ä¸€é”®åˆ‡æ¢ï¼Œæ•°æ®æ™ºèƒ½ä¿ç•™
- **ä¸“ä¸šè§„æ ¼æ˜¾ç¤º**ï¼šæ ¹æ®äº§å“ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„æŠ€æœ¯è§„æ ¼
- **è¯¦ç»†ä»·æ ¼æ˜ç»†**ï¼šææ–™è´¹ã€å·¥è‰ºè´¹ã€æ¡†æ¶è´¹ã€è¡¨é¢å¤„ç†è´¹åˆ†é¡¹æ˜¾ç¤º
- **é‡æŠ˜ä¼˜æƒ ä½“ç³»**ï¼š20+ä»¶5%æŠ˜æ‰£ï¼Œ50+ä»¶10%æŠ˜æ‰£ï¼Œ100+ä»¶15%æŠ˜æ‰£

### ğŸš€ éƒ¨ç½²å°±ç»ªçŠ¶æ€

ç³»ç»Ÿç°å·²å®Œå…¨å‡†å¤‡æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼š

#### å‰ç«¯åŠŸèƒ½ âœ…
- é’¢ç½‘æŠ¥ä»·è¡¨å•å®Œæ•´å¯ç”¨
- ä»·æ ¼è®¡ç®—å®æ—¶å‡†ç¡®
- å·¥è‰ºæŒ‡å¯¼ä¸“ä¸šè¯¦ç»†
- äº§å“åˆ‡æ¢æµç•…è‡ªç„¶

#### åç«¯æ”¯æŒ âœ…  
- APIæ™ºèƒ½è¯†åˆ«äº§å“ç±»å‹
- æ•°æ®éªŒè¯ä¸¥æ ¼å¯é 
- è®¢å•çŠ¶æ€ç®¡ç†å®Œå–„
- æ•°æ®åº“å…¼å®¹æ€§è‰¯å¥½

#### ç®¡ç†åŠŸèƒ½ âœ…
- é’¢ç½‘è®¢å•ä¸“ç”¨ç•Œé¢
- çŠ¶æ€æµè½¬æ“ä½œä¾¿æ·
- è§„æ ¼ä¿¡æ¯æ˜¾ç¤ºä¸“ä¸š
- æ‰¹é‡ç®¡ç†åŠŸèƒ½å®Œå¤‡

#### æµ‹è¯•éªŒè¯ âœ…
- APIæµ‹è¯•é¡µé¢å¯ç”¨ï¼š`/test-stencil-quote`
- å®Œæ•´æµç¨‹éªŒè¯é€šè¿‡
- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æ— è¯¯
- æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®

**ğŸ¯ å»ºè®®ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. åœ¨stagingç¯å¢ƒè¿›è¡Œæœ€ç»ˆéªŒæ”¶æµ‹è¯•
2. é…ç½®ç”Ÿäº§ç¯å¢ƒé’¢ç½‘ä»·æ ¼å‚æ•°
3. åˆ¶å®šé’¢ç½‘äº§å“ä¸Šçº¿è¥é”€ç­–ç•¥
4. è®­ç»ƒå®¢æœå›¢é˜Ÿé’¢ç½‘äº§å“çŸ¥è¯† 