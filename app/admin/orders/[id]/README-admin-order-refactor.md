# 管理员订单页面重构说明

## 🔄 重构概览

本次重构将管理员订单页面的操作按钮进行了整合，增加了邮件通知功能和状态管理，提升了订单处理的效率和用户体验。

## ✨ 主要改进

### 1. 统一操作中心
- **之前**: 各种计算和保存按钮分散在不同位置
- **现在**: 所有操作集中在一个 `AdminOrderActions` 组件中
- **包含操作**:
  - 🔧 PCB价格计算
  - 📅 交期计算  
  - 🚚 运费计算
  - 🔄 全部重算
  - 💾 保存/创建订单

### 2. 邮件通知系统
- **智能通知类型**: 根据订单状态自动推荐合适的邮件模板
- **通知类型**:
  - 📋 订单创建通知
  - 📝 订单更新通知
  - 🔄 状态变更通知
  - 💰 付款确认通知
  - 🏭 生产开始通知
  - 📦 订单发货通知
  - ✅ 订单完成通知

### 3. 快速状态操作
- **一键状态更新**: 常用状态变更一键完成
- **自动邮件通知**: 状态变更时自动发送相应通知
- **快速操作**:
  - 💰 确认付款
  - 🏭 开始生产
  - 📦 订单发货
  - ✅ 订单完成

### 4. 用户订单状态同步
- **状态同步**: 管理员订单状态变更时自动同步到用户订单
- **邮件通知**: 支持选择性发送邮件给客户
- **状态追踪**: 完整的订单状态流转记录

## 🏗️ 新增组件

### AdminOrderActions
```typescript
interface AdminOrderActionsProps {
  values: Record<string, unknown>;
  onSave: (values: Record<string, unknown>, options?: { 
    sendNotification?: boolean; 
    notificationType?: string 
  }) => void;
  onRecalc: (values: Record<string, unknown>) => void;
  onCalcPCB?: (values: Record<string, unknown>) => void;
  onCalcDelivery?: (values: Record<string, unknown>) => void;
  onCalcShipping?: (values: Record<string, unknown>) => void;
  isAdminOrderCreated: boolean;
  disabled?: boolean;
}
```

### 邮件通知API
- **路径**: `/api/admin/orders/notifications`
- **功能**: 发送订单相关邮件通知
- **支持模板**: 7种不同的通知类型

## 🎯 使用指南

### 管理员操作流程

1. **新订单处理**:
   - 查看订单详情和PCB规格
   - 使用计算功能获取准确价格和交期
   - 创建管理员订单并选择发送创建通知

2. **订单状态更新**:
   - 使用快速状态按钮进行常见状态变更
   - 系统自动选择合适的邮件模板
   - 一键完成状态更新+邮件通知

3. **价格调整**:
   - 修改价格、运费等信息
   - 使用重新计算功能验证价格
   - 保存时选择是否通知客户

### 邮件通知设置

- **开关控制**: 可选择是否发送邮件
- **类型选择**: 支持手动选择通知类型
- **智能推荐**: 根据订单状态自动推荐通知类型
- **预览功能**: 显示将要发送的通知类型说明

## 🔧 技术实现

### 后端API增强
- 订单创建/更新时支持邮件通知参数
- 用户订单状态自动同步
- 根据状态变化智能选择邮件模板

### 前端组件重构
- 操作逻辑集中管理
- 响应式设计，适配不同屏幕
- 状态管理和用户体验优化

### 邮件系统
- 使用nodemailer发送邮件
- 支持HTML模板
- 错误处理和重试机制

## 🚀 后续计划

1. **模板定制**: 支持管理员自定义邮件模板
2. **批量操作**: 支持批量处理多个订单
3. **通知历史**: 记录邮件发送历史
4. **客户反馈**: 收集客户对通知的反馈

## 📝 注意事项

- 邮件通知需要配置SMTP设置
- 确保用户邮箱地址准确有效
- 状态变更会影响用户端显示
- 价格计算依赖PCB规格数据完整性 