# PCB Pricing Rules V2 (Based on 线上报价单.csv)

## 1. 基础价格表

| 层数 | 工程费 | 0.2㎡以下样品打包价 | 0.21-0.5㎡ | 0.5-1㎡ | 1-3㎡ | 3-5㎡ | 5.01-10㎡ | 10-30㎡ | 30.01㎡以上 | 交期(工作日) |
|------|--------|---------------------|------------|---------|-------|-------|-----------|----------|-------------|--------------|
| 1层  | 180    | 300                 | 510        | 450     | 400   | 340   | 280       | 290      | 280         | 5-12+        |
| 2层  | 210    | 330                 | 560        | 510     | 470   | 440   | 400       | 370      | 320         | 5-13+        |
| 4层  | 500    | 610                 | 850        | 810     | 770   | 730   | 630       | 560      | 540         | 7-15+        |
| 6层  | 1100   | 1300                | 1300       | 1200    | 1150  | 1100  | 1000      | 950      | 930         | 9-17+        |
| 8层  | 1350   | 最少起订量5片      | 2000       | 1900    | 1900  | 1700  | 1700      | 1700     | 1600        | 10-18+       |
| 10层 | 1000   | 最少起订量5片      | 2500       | 2500    | 2400  | 2400  | 2300      | 2000     | 1850        | 11-18+       |
| 12层 | 1600   | 最少起订量5片      | 2600       | 2600    | 2500  | 2500  | 2400      | 2200     | 2100        | 12-19+       |
| 14层 | 2000   | 最少起订量5片      | 4000       | 4000    | 3800  | 3600  | 3600      | 3400     | 3400        | 13-20+       |
| 16层 | 2500   | 最少起订量5片      | 4500       | 4500    | 4300  | 4300  | 4300      | 4200     | 4100        | 15-22+       |
| 18层 | 3000   | 最少起订量5片      | 5500       | 5500    | 5300  | 5000  | 5000      | 4800     | 4600        | 17-24+       |
| 20层 | 3500   | 最少起订量5片      | 6500       | 6500    | 6200  | 6000  | 6000      | 5800     | 5700        | 18-25+       |

- 交期区间：详见原表，≥30㎡或高层数需评估。
- 标准工艺：FR-4（TG135）、板厚1.6mm、铜厚1oz、最小孔径0.25mm、线宽线距≥5/5mil（4层及以上4/4mil）、喷锡/OSP、IPC二级。

## 2. 特殊工艺加价

- 单/双面板4/4mil线路+50元（小于4/4mil不做）；四层板3.5/3.5mil加50元（小于3.5/3.5mil评估）；六层及以上≥3.5/3.5mil不加收费用（小于3.5/3.5mil评估）。
- 新单>5㎡无工程费，返单>3㎡不收工程费。
- 出货报告20元/款，切片报告20元（只要切片免费），阻抗报告20元。
- 飞针测试：0.5㎡以下免费（≤5万点），超出0.001元/点。
- 测试架：3㎡以上需开架，0.5元/点，最低500元/款。
- 菲林费：光绘面积超出0.06平方米, 按200元/平方米计费（1-2L按6张，4L按8张，6层按11张，8层按13张,10层按15张计费）
- 合拼板：1-2层多拼1款+60元（最多4款，第5款起+150/款），4层多拼1款+110元（第4款起+150/款），6层多拼1款+220元（最多2款），8层多拼1款+350元（最多2款）。
- 钻孔数：双面10万孔/㎡，多层15万孔/㎡，超出每万孔+10元/㎡（0.2mm及以上），0.15mm每万孔+30元/㎡。
- 打叉板：10拼以下单价+10%，10-20拼+20%，20-30拼+30%。

### 特殊工艺明细
- 沉金：1U+140元/㎡，样板+140元/款；2U+190元/㎡，样板+190元/款；3U+240元/㎡，样板+230元/款。
- 沉银/沉锡：+100元/㎡，样板+120元/款，交期+2天。
- 蓝胶：样品+120元/款，批量+100元/㎡，样品交期+2天，批量+3天。
- 孔铜25UM：+30元。
- 铜厚：单双面2OZ+100元，3OZ+320元，4OZ+550元；批量2OZ+100元，3OZ+310元，4OZ+510元。
- 板厚0.2-0.4mm：单双面单价+50%/㎡（样板+300元/款）。
- 板厚0.6-1.0mm：单双面单价-15元/㎡。
- 板厚1.2mm：单双面单价-10元/㎡。
- 板厚1.6-3.2mm：每加0.4mm，双面+100元/㎡，4层+80元/㎡，不足1㎡按1㎡计。
- TG150：样品单双面+80元/款，多层+100元/款，大于1㎡+60元/㎡，多层+80元/㎡。
- TG170：样品单双面+100元/款，多层+150元/款，大于1㎡+80元/㎡，多层+100元/㎡。
- 生益板材：普通+80元/款，批量+80元/㎡，TG150+120元/款，TG170+150元/款。
- 盲埋孔：每多1层，按加2层计，交期+2天。
- 压合：每加1张光板，费用+2层，PP每张+20元/㎡。
- 孔径比1/10：总价+15%，双面样板+80元，每多2层+80元。
- 盘中孔：样品+600元/款，批量+500元/㎡，样品交期+2天。
- 沉头孔：0.5元/个，最低150元/款，交期+2天。
- BGA≤0.25mm：批量+15%，样品最低100元/款。
- 阻抗：样品+50元/款，大于1㎡不收费，阻抗报告+30元/款。
- 半孔/金属包边：样板+100元/款，批量+100元/㎡，样品交期+1天，批量+2天。
- 金手指斜边：常规外斜边+50元/㎡，样品+50元/款，有要求外斜边1元/刀，板内2元/PCS，样品+200元/款，交期+2天。

### 菲林费详细计算说明
- 光绘面积 = 单片面积 × 菲林张数 × 拼板轮数（大板数量）
  - 单片面积 = 单片长 × 单片宽 / 10000
  - 菲林张数：1-2L按6张，4L按8张，6L按11张，8L按13张，10L按15张，其它层数按 layers+5 估算
  - 拼板轮数/大板数量：
    - **单片出货（shipmentType=single）时，拼板轮数/大板数量等于用户选择的单片出货总数量（totalCount）**
    - 连片/拼板出货（shipmentType=panel, panel_agent）时，优先使用 panelSet 字段（即连板/大板下单数量），如无 panelSet，则用 totalCount / singleCount 计算
    - panelSet = 实际下单的大板数量
    - totalCount = 总片数
    - singleCount = 每块拼板/大板上有多少个小板
    - 若 singleCount 未填写，默认1
- 费用规则：
  - 若光绘面积 ≤ 0.06㎡，不收取菲林费
  - 若光绘面积 > 0.06㎡，费用 = ceil(光绘面积 / 0.06) × 200
- 代码实现详见 lib/priceHandlers.ts 的 filmFeeHandler

#### 关于panelSet、singleCount与拼板轮数的说明
- **panelSet** 表示"连板/大板的下单数量"，即实际需要生产多少块拼板/大板。
- **singleCount** 表示"一块拼板上有多少个小板（单片）"。
- **totalCount** 表示"订单总片数"。
- 计算拼板轮数/大板数量时：
  - **单片出货（shipmentType=single）时，拼板轮数/大板数量=totalCount**
  - 连片/拼板出货时，优先用 panelSet，否则用 (totalCount / (singleCount || 1))
- 这样更直观、准确，避免除法容错问题。

**举例说明：**
- 单片出货：订单总片数100片（totalCount=100），shipmentType=single，单片面积0.01㎡，菲林张数6。
  - 拼板轮数/大板数量 = totalCount = 100
  - 总光绘面积 = 0.01 × 6 × 100 = 6㎡
- 连片/拼板出货：订单总片数100片（totalCount=100），每拼板10片（singleCount=10），panelSet=10，shipmentType=panel，单片面积0.01㎡，菲林张数6。
  - 拼板轮数/大板数量 = panelSet = 10
  - 总光绘面积 = 0.01 × 6 × 10 = 0.6㎡

> 只有拼板轮数/大板数量越多，菲林消耗才越多，费用才会增加。

## 3. 相关说明
- 标准工艺价格适用范围：FR-4（TG135）、板厚1.6mm、铜厚1oz、最小钻孔0.25mm、线宽线距≥5/5mil（4层及以上4/4mil）、喷锡/OSP、IPC二级。
- BGA小于0.25mm、板厚小于0.5mm不做喷锡。
- 常规板钻孔小于0.2mm不做。
- 板厚正常制程范围：1-4L 0.6-1.6mm，6L 0.8-1.6mm，8L 1.0-1.6mm，10L 1.2-1.6mm，12L及以上1.6mm。

## 4. 注意事项
- 价格表仅供参考，最终报价以实际评审为准。
- 复杂/特殊工艺请单独评估。
- 交期、最小起订量、特殊要求等请与业务确认。

## 字段-加价规则对照表

| 字段名 | 取值 | 默认值 | 加价规则 | 备注 |
|--------|------|--------|----------|------|
| pcbType | fr4/aluminum/rogers/flex/rigid-flex | fr4 | aluminum+30, rogers+50, flex+40, rigid-flex+60 | 板材类型 |
| layers | 1/2/4/6/8/10/12/14/16/18/20 | 2 | 见基础价格表 | 层数 |
| thickness | 0.2/0.4/0.6/0.8/1.0/1.2/1.6/2.0/2.5/3.0/3.2 | 1.6 | 0.2-0.4mm+300元/款，0.6-1.0mm-15元/㎡，1.2mm-10元/㎡，>1.6mm每0.4mm双面+100元/㎡，4层+80元/㎡ | 板厚区间细分 |
| hdi | none/1step/2step/3step | none | 非none加2倍工程费 | 盲埋孔 |
| tg | TG130/TG150/TG170 | TG130 | TG150+80, TG170+100 | TG值 |
| shipmentType | single/panel/panel_agent | single | panel+10, panel_agent+20 | 出货方式 |
| singleLength | number | - | - | 单片长(cm) |
| singleWidth | number | - | - | 单片宽(cm) |
| singleCount | number | - | - | 单片数量 |
| panelCount | number | 1 | >1每多1拼+60元，10拼以下+10%，10-20拼+20%，20-30拼+30% | 拼板/打叉板 |
| border | none/5/10 | 5 | none+10 | 工艺边 |
| copperWeight | 1/2/3/4 | 1 | 2OZ+100, 3OZ+320, 4OZ+550 | 铜厚 |
| minTrace | 10/10,8/8,6/6,5/5,4/4,3.5/3.5 | 6/6 | 1-2层4/4+50, 4层3.5/3.5+50, 其它需评估 | 线宽线距 |
| minHole | 0.3/0.25/0.2/0.15 | 0.3 | 0.15需评估 | 最小孔径 |
| solderMask | green/blue/red/yellow/black/white | green | - | 阻焊色 |
| silkscreen | white/black | white | - | 字符色 |
| surfaceFinish | hasl/leadfree/enig/osp/immersion_silver/immersion_tin | hasl | enig+140元/㎡, immersion_silver+100元/㎡, immersion_tin+100元/㎡，blue_mask样品+120元/款，批量+100元/㎡，hole_cu_25um+30元 | 表面处理 |
| impedance | yes/no | no | yes+50 | 阻抗 |
| castellated | yes/no | no | yes+100 | 半孔/金属包边 |
| goldFingers | yes/no | no | 需评审资料 | 金手指 |
| edgePlating | yes/no | no | yes+20 | 边镀金 |
| halfHole | none/1/2/3/4/2half/3half/4half | none | 非none+100 | 半孔数量 |
| edgeCover | none/1/2/3/4/2cover/3cover/4cover | none | 非none+20 | 边覆盖 |
| maskCover | plug/plug_flat/other | - | plug/plug_flat+10 | 阻焊覆盖 |
| flyingProbe | yes/no | no | yes+10 | 飞针测试 |
| testMethod | free/paid | free | paid+10 | 测试方式 |
| prodCap | auto/manual | auto | manual+10 | 产能确认 |
| productReport | none/shipment/cut/sample | none | shipment+20 | 产品报告 |
| rejectBoard | accept/reject | accept | reject+10 | 不良板 |
| yyPin | none/need | none | need+10 | 阴阳针 |
| customerCode | none/add/add_pos | none | add+10, add_pos+15 | 客户加码 |
| payMethod | auto/manual | auto | manual+5 | 付款方式 |
| qualityAttach | standard/full | standard | full+20 | 质检附件 |
| smt | need/none | none | need+50 | SMT贴片 |
| syMaterial | sy/sy_tg150/sy_tg170 | - | sy+80, sy_tg150+120, sy_tg170+150 | 生益板材 |
| holeCount | number | - | >10万孔每多1万+10元/㎡，0.15mm孔径每多1万+30元/㎡ | 钻孔数/孔密度 |
| bga | yes/no | no | yes+15% | BGA≤0.25mm |
| blueMask | true/false | false | true时按表面处理规则加价 | 蓝胶 |
| holeCu25um | true/false | false | true时+30元 | 孔铜25um |

## 详细加价规则说明

- ...（保留原有详细说明，补充所有字段的加价规则、取值范围、默认值、加价明细）
- 蓝胶（blue_mask）：面积<1㎡时加120元，≥1㎡时100元/㎡，样品交期+2天，批量交期+3天以上。
- 孔铜25um（hole_cu_25um）：加价30元。

## 常见问题说明

- 超出表格范围、极端参数、特殊工艺组合等，系统会自动提示"需人工评估"。
- 交期、最小起订量会根据特殊工艺动态调整。
- 价格明细会在前端明细弹窗中展示。

## 其它

- 详细规则请参考线上报价单原文和本系统实现。

## 测试费计算规则

PCB测试费的计算遵循如下自动调整与计费逻辑：

1. **面积≤0.5㎡**：
   - 测试费免费，实际测试方式为"none"。
2. **单层板（layers=1）**：
   - 允许选择"none"、"flyingProbe"（飞针测试）、"fixture"（测试架）。
   - 若传入非法值，自动修正为"none"。
   - 费用：
     - none：免费
     - flyingProbe：60元 × max(1, 面积)
     - fixture：500元
3. **多层板（layers>1）**：
   - 不允许选择"none"，如传入"none"或未传入，面积≤5㎡时自动修正为"flyingProbe"，面积>5㎡时自动修正为"fixture"。
   - 费用：
     - flyingProbe：
       - 2-6层：60元 × max(1, 面积)
       - 8层及以上：100元 × max(1, 面积)
     - fixture：
       - 1-6层：500元
       - 8层：800元
       - 10层及以上：1000元
4. **面积>5㎡**：
   - 只能选择"fixture"，费用按层数对应标准收取。
5. **其它情况**：
   - 若传入的测试方式不合法，系统会自动修正为合适的方式，并在报价明细中注明"实际测试方式"。

**返回说明：**
- 系统会在报价明细的备注中注明"实际测试方式"，便于用户知晓自动调整结果。
- 详细实现见`lib/pcb-calc-v2.ts`的`calcTestFee`函数。

**示例：**
- 4层板，面积0.3㎡，选择"none" → 实际测试方式为"flyingProbe"，费用=60元。
- 2层板，面积6㎡，选择"flyingProbe" → 实际测试方式为"fixture"，费用=500元。
- 1层板，面积0.4㎡，选择"fixture" → 实际测试方式为"fixture"，费用=500元。
- 8层板，面积2㎡，选择"flyingProbe" → 实际测试方式为"flyingProbe"，费用=100×2=200元。

如有特殊需求或人工评估情况，系统会在备注中提示。

## 工程费计算规则

PCB工程费分为三档，具体规则如下：

1. **S≤0.5㎡**：
   - 工程费取csv表中"工程费"列（如1层210元、2层210元、4层500元等）。
2. **0.5㎡<S≤3㎡**：
   - 工程费取csv表中"工程费S＞0.5"列（如1层142元、2层142元、4层425元等）。
3. **S>3㎡**：
   - 工程费取csv表中"工程费S>3.0"列（所有层数均为0元，即大于3㎡不收工程费）。

**分档逻辑说明：**
- 计算面积S = 单片长 × 单片宽 × 单片数量 / 10000，单位为㎡。
- 按面积区间自动选择对应档位的工程费。
- 工程费明细会在报价明细的notes中体现。

**示例：**
- 2层板，面积0.3㎡，工程费=210元。
- 4层板，面积1.2㎡，工程费=425元。
- 6层板，面积3.5㎡，工程费=0元。

详细实现见`lib/pcb-calc-v2.ts`主函数相关代码。

## 多款拼板加价规则

多款拼板（Different Designs Panelization）加价规则如下：

- 仅当一个大板（Panel）上拼有多于1种不同设计（differentDesignsCount > 1）时收取加价。
- 加价仅针对多余的设计数（即 differentDesignsCount-1）。
- 具体加价标准按层数分档：

| 层数 | 设计数区间 | 公式 | 说明 |
|------|------------|------|------|
| 1-2层 | 2-4款 | (n-1) × 60元 | 每多1款+60元 |
| 1-2层 | ≥5款 | 3×60 + (n-4)×150元 | 第5款起每多1款+150元 |
| 4层   | 2-3款 | (n-1) × 110元 | 每多1款+110元 |
| 4层   | ≥4款 | 2×110 + (n-3)×150元 | 第4款起每多1款+150元 |
| 6层   | 2款   | 1×220元 | 2款时+220元 |
| 6层   | ≥3款 | 1×220 + (n-2)×350元 | 第3款起每多1款+350元 |
| 8层   | 2款   | 1×350元 | 2款时+350元 |
| 8层   | ≥3款 | 1×350 + (n-2)×450元 | 第3款起每多1款+450元 |

- 其它层数或仅1款不加价，需人工审核。
- 总加价 = 单板加价 × 总片数（totalCount）。

**示例：**
- 2层，5款，totalCount=100：加价 = [3×60 + 1×150] × 100 = 330 × 100 = 33,000元
- 4层，4款，totalCount=50：加价 = [2×110 + 1×150] × 50 = 370 × 50 = 18,500元
- 6层，3款，totalCount=20：加价 = [1×220 + 1×350] × 20 = 570 × 20 = 11,400元
- 8层，2款，totalCount=10：加价 = [1×350] × 10 = 350 × 10 = 3,500元

详细实现见`lib/pcb-calc-v2.ts`的`calculatePanelingFee`函数。 
详细实现见`lib/pcb-calc-v2.ts`主函数相关代码。 

# PCB 线宽线距、钻孔和板厚加价规则说明

## 线宽线距加价
- 1L/2L：
  - 4/4mil 样品 +60元
  - <4/4mil 不做
  - 批量 +60元/㎡
- 4L：
  - 3.5/3.5mil 样品 +60元
  - <3.5/3.5mil 不做
  - 批量 +60元/㎡
- 6L/8L/≥10L：
  - 3.5/3.5mil 及以上不收费
  - <3.5/3.5mil 不做

## 钻孔和板厚加价
- 板厚≥1.6mm：
  - 1L：≥0.3mm，不加价；<0.3mm不做
  - 2L：0.2mm样品+50元，<0.2mm不做，批量+50元/㎡
- 板厚<1.6mm：
  - 1L：≥0.3mm，不加价；<0.3mm不做
  - 2L：0.15mm样品+150元，<0.15mm不做，批量+130元/㎡
  - 4L：0.15mm样品+60元，批量+60元/㎡
  - 6L/8L/≥10L：0.15mm样品+50元，批量+50元/㎡

## 说明
- "样品"与"批量"可通过表单字段区分，当前代码默认按样品处理。
- 不支持的线宽线距/孔径会在备注中提示"not supported"。
- 费用明细会在报价明细中体现。

## 示例
- 2层板，线宽线距4/4mil，最小孔径0.2mm，板厚1.6mm：
  - 线宽线距加价：+60元
  - 钻孔加价：+50元
- 4层板，线宽线距3.5/3.5mil，最小孔径0.15mm，板厚1.2mm：
  - 线宽线距加价：+60元
  - 钻孔加价：+60元

---

> 以上规则已在`calcTraceAndDrillExtra`函数中实现，详见`lib/pcb-calc-v2.ts`。 